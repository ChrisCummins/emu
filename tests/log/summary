set -eu
test_setup

cd /tmp/emu/test-source
emu init -v

emu sink -v add origin ../test-sink

emu snapshot -v

emu log > /tmp/emu/log
emu log -s > /tmp/emu/log-summary

if [[ "$(wc -l /tmp/emu/log | awk '{ print $1 }')" -lt "$(wc -l /tmp/emu/log-summary | awk '{ print $1 }')" ]]
then
    echo "Summary test failed!"
    echo "emu log:"
    cat /tmp/emu/log
    echo "emu log -s:"
    cat /tmp/emu/log-summary
    exit 5
fi

if [[ "$(wc -l /tmp/emu/log-summary | awk '{ print $1 }')" -ne 2 ]]
then
    echo "Summary test failed!"
    echo "emu log:"
    cat /tmp/emu/log-summary
    exit 5
fi

sleep 1
emu snapshot -v
emu log -s > /tmp/emu/log-summary
if [[ "$(wc -l /tmp/emu/log-summary | awk '{ print $1 }')" -ne 3 ]]
then
    echo "Summary test failed!"
    echo "emu log:"
    cat /tmp/emu/log-summary
    exit 5
fi

test_teardown
