set -ue
test_setup

cd $EMU_TEST_DIR/test-source
echo "emu init -v"
emu init -v
echo "emu sink add origin $EMU_TEST_DIR/test-sink"
emu sink add origin $EMU_TEST_DIR/test-sink

assert_fail "emu sink -v add origin $EMU_TEST_DIR/test-sink"

emu init -v
emu sink -v add test $EMU_TEST_DIR/test-new

assert_is_dir "$EMU_TEST_DIR/test-new"
assert_dir_is_not_empty "$EMU_TEST_DIR/test-new"
assert_is_dir "$EMU_TEST_DIR/test-new/.emu/config"
assert_is_dir "$EMU_TEST_DIR/test-new/.emu/nodes"
assert_is_dir "$EMU_TEST_DIR/test-new/.emu/trees"

assert_is_file "$EMU_TEST_DIR/test-new/.emu/HEAD"
assert_file_is_empty "$EMU_TEST_DIR/test-new/.emu/HEAD"

assert_is_file "$EMU_TEST_DIR/test-new/.emu/SOURCE"
assert_file_is_not_empty "$EMU_TEST_DIR/test-new/.emu/SOURCE"
assert "$(cat /tmp/test-new/.emu/SOURCE) == $EMU_TEST_DIR/test-source"

test_teardown
