test_setup
source /usr/local/lib/libemu

cd $EMU_TEST_DIR/test-source

set +u

# test absolute paths
pushd .
mkdir -pv a/b/c
assert_strings_match "$EMU_TEST_DIR/test-source/a" $(get_absolute_path a)
assert_strings_match "$EMU_TEST_DIR/test-source/a/b" $(get_absolute_path a/b)
assert_strings_match "$EMU_TEST_DIR/test-source/a/b/c" $(get_absolute_path a/b/c)
popd

# test empty source
get_source_dir
get_stack_dir
assert_string_is_empty $SOURCE_DIR
assert_string_is_empty $STACK_DIR

echo "assert_fail is_source"
assert_fail is_source
echo "assert_fail is_stack"
assert_fail is_stack

# test populated source
emu init -v

echo "assert_success is_source"
assert_success is_source
echo "assert_fail is_stack"
assert_fail is_stack

get_source_dir
get_stack_dir

assert_string_is_not_empty $SOURCE_DIR
assert_strings_match "$SOURCE_DIR" "$(pwd)"
assert_string_is_empty $STACK_DIR

# test empty source
rm -fr .emu

get_source_dir
assert_string_is_empty $SOURCE_DIR

# test empty source recurse
emu init -v
mkdir -pv test/a/b/c/d
cd test/a/b/c/d
get_source_dir
assert_string_is_not_empty $SOURCE_DIR
cd ../../../../../
assert_strings_match "$SOURCE_DIR" "$(pwd)"

# test empty stack
mkdir -pv ../test-stack
cd ../test-stack
get_source_dir
get_stack_dir
assert_string_is_empty $SOURCE_DIR
assert_string_is_empty $STACK_DIR
echo "assert_fail is_source"
assert_fail is_source
echo "assert_fail is_stack"
assert_fail is_stack

# test populated stack
cd ../test-source
emu stack -v add test ../test-stack
cd ../test-stack
get_stack_dir
get_source_dir
assert_string_is_not_empty $STACK_DIR
assert_string_is_empty $SOURCE_DIR
echo "assert_success is_stack"
assert_success is_stack
echo "assert_fail is_source"
assert_fail is_source

# test empty source recurse
mkdir -pv test/a/b/c/d
cd test/a/b/c/d
get_stack_dir
assert_string_is_not_empty $STACK_DIR
cd ../../../../../
assert_strings_match "$STACK_DIR" "$(pwd)"

test_teardown
