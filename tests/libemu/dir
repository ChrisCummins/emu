set -e
test_setup
source /usr/local/lib/libemu

cd /tmp/emu/test-source

# test absolute paths
pushd .
mkdir -pv a/b/c
assert_strings_match "/tmp/emu/test-source/a" $(get_absolute_path a)
assert_strings_match "/tmp/emu/test-source/a/b" $(get_absolute_path a/b)
assert_strings_match "/tmp/emu/test-source/a/b/c" $(get_absolute_path a/b/c)
popd

# test empty source
set +e
get_source_dir
get_sink_dir
set -e
assert_string_is_empty $SOURCE_DIR
assert_string_is_empty $SINK_DIR

echo "assert_fail is_source"
assert_fail is_source
echo "assert_fail is_sink"
assert_fail is_sink

# test populated source
emu init -v

echo "assert_success is_source"
assert_success is_source
echo "assert_fail is_sink"
assert_fail is_sink

get_source_dir
set +e
get_sink_dir
set -e
assert_string_is_not_empty $SOURCE_DIR
assert_strings_match "$SOURCE_DIR" "$(pwd)"
assert_string_is_empty $SINK_DIR

# test empty source
rm -fr .emu
set +e
get_source_dir
set -e
assert_string_is_empty $SOURCE_DIR

# test empty source recurse
emu init -v
mkdir -pv test/a/b/c/d
cd test/a/b/c/d
get_source_dir
assert_string_is_not_empty $SOURCE_DIR
cd ../../../../../
assert_strings_match "$SOURCE_DIR" "$(pwd)"

# test empty sink
mkdir -pv ../test-sink
cd ../test-sink
set +e
get_source_dir
get_sink_dir
set -e
assert_string_is_empty $SOURCE_DIR
assert_string_is_empty $SINK_DIR
echo "assert_fail is_source"
assert_fail is_source
echo "assert_fail is_sink"
assert_fail is_sink

# test populated sink
cd ../test-source
emu sink -v add test ../test-sink
cd ../test-sink
get_sink_dir
set +e
get_source_dir
set -e
assert_string_is_not_empty $SINK_DIR
assert_string_is_empty $SOURCE_DIR
echo "assert_success is_sink"
assert_success is_sink
echo "assert_fail is_source"
assert_fail is_source

# test empty source recurse
mkdir -pv test/a/b/c/d
cd test/a/b/c/d
get_sink_dir
assert_string_is_not_empty $SINK_DIR
cd ../../../../../
assert_strings_match "$SINK_DIR" "$(pwd)"

test_teardown
