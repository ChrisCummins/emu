set -eu
test_setup

cd $EMU_TEST_DIR/test-source

emu init -v
emu sink -v add origin ../test-sink

assert_is_file .emu/excludes

echo "- test" >> .emu/excludes
echo "hello, world!" > test
emu push -v

hash=$(ls ../test-sink/.emu/trees)
assert_is_dir ../test-sink/.emu/trees/$hash
assert_is_not_file ../test-sink/.emu/trees/$hash/test

rm -rfv ../test-sink/.emu/trees/$hash ../test-sink/.emu/nodes/$hash ../test-sink/.emu/HEAD

sleep 1
emu push -v
assert_is_dir ../test-sink/.emu/trees/$hash
assert_is_file ../test-sink/.emu/trees/$hash/test

test_teardown
