#!/bin/bash

source /usr/local/lib/libemu
EMU_ECHO_PREFIX=$(basename "$0")
SOURCE_DIR="$(pwd)"

help ()
{
    man emu-log
}

print_node_verbose ()
{
cat <<EOF >>.emu_log
$NODE
  Date: $DATE
  Size: $SIZE

EOF
}

print_node_dense ()
{
cat <<EOF >>.emu_log
 $NODE * $DATE
EOF
}

# Print the nodes for a sink.
#
# @param $1 Name of sink.
print_nodes ()
{
    print_sink_details $1 >> .emu_log

    SINK_PATH="$(cat $SOURCE_DIR/.emu/sinks/$1)"
    for NODE in $(ls "$SINK_DIR/.emu/nodes" | sort -r)
    do
        NODE_PATH="$SINK_PATH/.emu/nodes/$NODE"
        DATE="$(cat $NODE_PATH | grep Date | sed -r 's/Date +(.*)/\1/')"
        SIZE="$(cat $NODE_PATH | grep Size | sed -r 's/Size +(.*)/\1/')"

        print_node_verbose $NODE
    done
    cat .emu_log | less
    rm -f .emu_log
}

main ()
{
    if [[ "$1" == "help" ]]
    then
        help
        exit 0
    fi

    pre_exec_hooks "$SOURCE_DIR"

    if [[ "$1" == "" ]]
    then
        emu_error "no sink specified"
        emu_panic
        exit $EMU_EXIT_INCORRECT_COMMAND
    fi

    SINK_DIR="$(cat $SOURCE_DIR/.emu/sinks/$1 2>/dev/null)"
    if [[ ! -f "$SOURCE_DIR/.emu/sinks/$1" ]] || [[ ! -d "$SINK_DIR" ]]
    then
        emu_error "sink '$1' does not exist"
        emu_panic
        exit $EMU_EXIT_ERROR
    fi

    print_nodes "$1"

    post_exec_hooks "$SOURCE_DIR"
    exit 0
}
main $@
