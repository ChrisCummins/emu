#!/bin/sh

source /usr/share/emu/emu-util
SCRIPT=$(basename $0)

SOURCE_DIR="$(pwd)"
CONF_DIR="$SOURCE_DIR/.$PROG"

help ()
{
    echo "\
$SCRIPT - Create or reinitialize an existing $PROG source.

This command is non-destructive, running it on an existing emu source will not
overwrite any existing data. Instead, it can be used to rescue a broken source,
as it will silently replace or recreate any missing files. If you have broken a
file and would like to revert to the default, delete it and run this command."
}

create_directories ()
{
    mkdir -p "$CONF_DIR"
    mkdir -p "$CONF_DIR/config"
    mkdir -p "$CONF_DIR/sinks"
    chmod 0755 "$CONF_DIR/sinks"
}

copy_template_files ()
{
    TEMPLATE_DIR="/usr/share/$PROG/source-templates"

    # Copy over files from shared templates dir.
    # If a file already exists, don't overwrite.
    cp -n "$TEMPLATE_DIR/excludes" "$CONF_DIR"
    cp -nr "$TEMPLATE_DIR/hooks" "$CONF_DIR"
}

init_filesystem ()
{
    create_directories
    copy_template_files
}

if [[ "$1" == "help" ]]
then
    help
    exit 0
fi

if [[ -d .emu ]]
then
    init_filesystem
    echo "$SCRIPT: Reinitialized existing source in $CONF_DIR"
else
    init_filesystem
    echo "$SCRIPT: Initialized source in $CONF_DIR"
fi

exit 0
