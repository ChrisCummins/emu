set -e
test_setup
source @prefix@/libexec/emu/libemu

cd $EMU_TEST_DIR/test-source

emu init -v

lock_dir

cat <<EOF > $EMU_TEST_DIR/test-source/.emu/hooks/exec/test.error
#!/bin/bash
echo "**** TEST EXECUTING *****"
touch $EMU_TEST_DIR/HOOK
echo "1234" > $EMU_TEST_DIR/HOOK
EOF

cat <<EOF > $EMU_TEST_DIR/test-source/.emu/hooks/exec/test2.error
#!/bin/bash
echo "**** TEST2 EXECUTING *****"
touch $EMU_TEST_DIR/HOOK2
EOF

chmod +x .emu/hooks/exec/*

echo "emu_panic"
emu_panic

assert_is_file $EMU_TEST_DIR/HOOK2
assert_file_is_empty $EMU_TEST_DIR/HOOK2

assert_is_file $EMU_TEST_DIR/HOOK
assert_strings_match "1234" "$(cat $EMU_TEST_DIR/HOOK)"

test_teardown
