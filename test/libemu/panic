set -e
test_setup
source /usr/local/lib/libemu

cd /tmp/emu/test-source

emu init -v

lock_dir

cat <<EOF > /tmp/emu/test-source/.emu/hooks/exec/test.error
#!/bin/bash
echo "**** TEST EXECUTING *****"
touch /tmp/emu/HOOK
echo "1234" > /tmp/emu/HOOK
EOF

cat <<EOF > /tmp/emu/test-source/.emu/hooks/exec/test2.error
#!/bin/bash
echo "**** TEST2 EXECUTING *****"
touch /tmp/emu/HOOK2
EOF

chmod +x .emu/hooks/exec/*

echo "emu_panic"
emu_panic

assert_is_file /tmp/emu/HOOK2
assert_file_is_empty /tmp/emu/HOOK2

assert_is_file /tmp/emu/HOOK
assert_strings_match "1234" "$(cat /tmp/emu/HOOK)"

test_teardown
